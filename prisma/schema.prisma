datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

enum RoleType {
  regular
  cashier
  manager
  superuser
}

enum TransactionType {
  purchase
  redemption
  adjustment
  event
  transfer
}

enum PromotionType {
  automatic
  onetime
}


model User {
  id          Int    @id @default(autoincrement())
  utorid      String  @unique
  name        String
  email       String  @unique
  password    String?
  birthday    DateTime?
  role        RoleType?
  points      Int
  avatarUrl   String?
  suspicious  Boolean
  verified    Boolean
  promotions  Promotion[]
  transactions Transaction[]
  transfersSent     Transfer[] @relation("SentTransfers")
  transfersReceived Transfer[] @relation("ReceivedTransfers")
  organizer    Event[] @relation("eventOrganizer")
  guest    Event[] @relation("eventGuest")
  token    Token?
}

model Token {
  id           Int      @id @default(autoincrement())
  resetToken  String
  createdAt   DateTime
  expiresAt   DateTime
  lastLogin   DateTime
  user   User @relation(fields: [userId], references: [id])
  userId Int  @unique
}

model Promotion {
  id           Int      @id @default(autoincrement())
  name         String
  description  String
  startTime    DateTime
  endTime      DateTime
  minSpending  Float? 
  rate         Float? 
  points       Int?
  user       User @relation(fields: [userId], references: [id])
  userId     Int
  transactions Transaction[]
}

model Transaction {
  id         Int   @id @default(autoincrement())
  type       TransactionType
  relatedId  Int
  spent      Float
  earned     Int
  amount     Int?
  remark     String?
  redeemed   Int?
  suspicious Boolean
  promotionIds  Promotion[]
  transferIds   Transfer[]
  user       User @relation(fields: [createdBy], references: [utorid])
  createdBy   String
  // utorid of user???
  // processedBy???
}

model Transfer {
  id         Int @id @default(autoincrement())
  type       TransactionType
  sent       Int
  senderId   String
  sender     User     @relation("SentTransfers", fields: [senderId], references: [utorid])
  recipientId String
  recipient   User     @relation("ReceivedTransfers", fields: [recipientId], references: [utorid])
  transactionId Int
  transaction   Transaction @relation(fields: [transactionId], references: [id])
}

model Event {
  id      Int @id @default(autoincrement())
  name    String
  description String
  location    String
  startTime   DateTime
  endTime     DateTime
  capacity    Int?
  points      Int
  published   Boolean
  organizerId String
  organizers  User @relation("eventOrganizer", fields: [organizerId], references: [utorid])
  guestId String
  guests  User @relation("eventGuest", fields: [guestId], references: [utorid])
}

