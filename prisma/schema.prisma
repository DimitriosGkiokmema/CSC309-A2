datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

enum RoleType {
  regular
  cashier
  manager
  superuser
}

enum TransactionType {
  purchase
  redemption
  adjustment
  event
  transfer
}

enum PromotionType {
  automatic
  onetime
}

model User {
  id          Int    @id @default(autoincrement())
  utorid      String  @unique
  name        String
  email       String  @unique
  password    String?
  birthday    DateTime?
  role        RoleType?
  points      Int
  avatarUrl   String?
  suspicious  Boolean
  verified    Boolean
  token       String 
  createdAt   DateTime
  expiresAt   DateTime
  lastLogin   DateTime?
  promotions  Promotion[]
  buyers      Transaction[] @relation("buyer")
  cashiers Transaction[] @relation("cashier")
  organizer    Event[] @relation("eventOrganizer")
  guest    Event[] @relation("eventGuest")
}

model Promotion {
  id           Int      @id @default(autoincrement())
  name         String
  description  String
  type         PromotionType @default(automatic)
  startTime    DateTime
  endTime      DateTime
  minSpending  Float? 
  rate         Float? 
  points       Int?
  user       User @relation(fields: [userId], references: [id])
  userId     Int
  transactions Transaction[]
}

model Transaction {
	id Int @id @default(autoincrement())
	utorid String @unique
	type String
	spent Float
	earned Int 

	relatedId Int
	remark String
	
	createdBy String
	cashier User @relation("buyer", fields: [createdBy], references: [utorid])
	suspicious Boolean


	amount Int 
	sender String
	recipient String 

	awarded Int

	transfer User @relation("cashier", fields: [relatedId], references: [id])
	event Event @relation(fields: [relatedId], references: [id])
	promotions Promotion[] 

	processedBy String?
	processed Boolean
}

model Event {
  id      Int @id @default(autoincrement())
  name    String
  description String
  location    String
  startTime   DateTime
  endTime     DateTime
  capacity    Int?
  pointsRemain  Int
  pointsAwarded Int
  published   Boolean
  organizers  User[] @relation("eventOrganizer")
  guests User[] @relation("eventGuest")
  transactions Transaction[]
}