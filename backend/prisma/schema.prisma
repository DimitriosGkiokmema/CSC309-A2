datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

enum RoleType {
  regular
  cashier
  manager
  superuser
}

enum TransactionType {
  purchase
  redemption
  adjustment
  event
  transfer
}

enum PromotionType {
  automatic
  onetime
}



model User {
  id          Int    @id @default(autoincrement())
  utorid      String  @unique
  name        String
  email       String  @unique
  password    String?
  birthday    DateTime?
  role        String?
  points      Int
  avatarUrl   String?
  suspicious  Boolean
  verified    Boolean
  token       String? @unique
  createdAt   DateTime?
  expiresAt   DateTime?
  lastLogin   DateTime?
  // promotions  Promotion[]
  // buyers      Transaction[] @relation("buyer") //recipient
  // cashiers Transaction[] @relation("cashier") //creator
  organizer    Event[] @relation("eventOrganizer")
  guest    Event[] @relation("eventGuest")
  usages    Usage[]
}


model Promotion {
  id           Int           @id @default(autoincrement())
  name         String
  type         String        @default("automatic")
  startTime    DateTime
  endTime      DateTime 
  isOneTime    Boolean       @default(false)
  minSpending  Int?
  rate         Float?
  points       Int?
  usages       Usage[]
  description  String?
  transactions Transaction[]
}

model Transaction {
	id Int @id @default(autoincrement())
	utorid String 
	type String
	spent Float?
	earned Int?

	relatedEventId Int?
  relatedTxId Int?
	remark String?
	
	createdBy String
	// cashier User? @relation("cashier", fields: [createdBy], references: [utorid])
	suspicious Boolean


	amount Int 
	sender String?
	recipient String?

	awarded Int?

	// buyer User? @relation("buyer", fields: [recipient], references: [utorid])
	event Event? @relation(fields: [relatedEventId], references: [id])
  transaction Transaction? @relation("TransactionToTransaction", fields: [relatedTxId], references: [id])
  reverseTransaction Transaction[] @relation("TransactionToTransaction")
	promotions Promotion[] 

	processedBy String?
	processed Boolean
}


model Event {
  id      Int @id @default(autoincrement())
  name    String
  description String
  location    String
  startTime   DateTime
  endTime     DateTime
  capacity    Int?
  pointsRemain  Int
  pointsAwarded Int
  published   Boolean
  organizers  User[] @relation("eventOrganizer")
  guests User[] @relation("eventGuest")
  transactions Transaction[]
}

model Usage {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id])
  promotionId Int
  promotion   Promotion @relation(fields: [promotionId], references: [id])
}
